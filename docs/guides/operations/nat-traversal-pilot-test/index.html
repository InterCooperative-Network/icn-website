<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="description" content="A substrate daemon for the cooperative internet. DIDs, trust graphs, mutual credit, CCL contracts, and democratic governance — all in one P2P coordination layer."><meta name="theme-color" content="#06090f"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@600;700;800&display=swap" rel="stylesheet"><title>NAT Traversal Pilot Test Guide | InterCooperative Network</title><link rel="stylesheet" href="/_astro/about.CVp5mvbJ.css">
<style>.breadcrumb[data-astro-cid-uadgga6g]{display:flex;align-items:center;gap:var(--space-xs);font-size:.8125rem;margin-bottom:var(--space-lg);flex-wrap:wrap}.breadcrumb[data-astro-cid-uadgga6g] a[data-astro-cid-uadgga6g]{color:var(--accent-teal)}.breadcrumb-sep[data-astro-cid-uadgga6g]{color:var(--text-muted)}.breadcrumb-dir[data-astro-cid-uadgga6g]{color:var(--text-secondary);text-transform:capitalize}.breadcrumb-current[data-astro-cid-uadgga6g]{color:var(--text-primary);text-transform:capitalize}.doc-meta[data-astro-cid-uadgga6g]{margin-bottom:var(--space-xl);padding-bottom:var(--space-md);border-bottom:1px solid var(--border-subtle)}.source-link[data-astro-cid-uadgga6g]{font-size:.8125rem;color:var(--text-muted)}.source-link[data-astro-cid-uadgga6g]:hover{color:var(--accent-teal)}.doc-footer[data-astro-cid-uadgga6g]{margin-top:var(--space-3xl);padding-top:var(--space-xl);border-top:1px solid var(--border-subtle)}
</style></head> <body> <!-- Navigation --> <nav class="nav" id="main-nav"> <div class="nav-inner"> <a href="/" class="nav-logo"> <svg class="nav-logo-svg" width="28" height="28" viewBox="0 0 128 128" fill="none"> <rect width="128" height="128" rx="28" fill="url(#nav-bg)"></rect> <line x1="64" y1="30" x2="34" y2="82" stroke="url(#nav-teal)" stroke-width="4" stroke-linecap="round" opacity="0.6"></line> <line x1="64" y1="30" x2="94" y2="82" stroke="url(#nav-teal)" stroke-width="4" stroke-linecap="round" opacity="0.6"></line> <line x1="34" y1="82" x2="94" y2="82" stroke="url(#nav-teal)" stroke-width="4" stroke-linecap="round" opacity="0.6"></line> <circle cx="64" cy="30" r="11" fill="url(#nav-teal)"></circle> <circle cx="34" cy="82" r="11" fill="url(#nav-teal)"></circle> <circle cx="94" cy="82" r="11" fill="url(#nav-teal)"></circle> <circle cx="64" cy="64" r="4" fill="url(#nav-teal)" opacity="0.8"></circle> <defs> <linearGradient id="nav-bg" x1="0" y1="0" x2="1" y2="1"><stop stop-color="#0f2027"></stop><stop offset="1" stop-color="#0a1628"></stop></linearGradient> <linearGradient id="nav-teal" x1="0" y1="0" x2="1" y2="1"><stop stop-color="#2dd4bf"></stop><stop offset="1" stop-color="#38bdf8"></stop></linearGradient> </defs> </svg> <span>ICN</span> </a> <ul class="nav-links" id="nav-links"> <li><a href="/about">About</a></li> <li><a href="/docs" class="active">Docs</a></li> <li><a href="/architecture">Architecture</a></li> <li><a href="/roadmap">Roadmap</a></li> <li><a href="/community">Community</a></li> </ul> <div class="nav-cta"> <a href="https://github.com/InterCooperative-Network/icn" target="_blank" rel="noopener" class="nav-github" aria-label="GitHub"> <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"></path></svg> </a> <a href="/docs/GETTING_STARTED" class="btn btn-primary btn-sm">Get Started</a> </div> <button class="nav-toggle" id="nav-toggle" aria-label="Toggle menu"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h18"></path></svg> </button> </div> </nav> <!-- Main Content --> <main>  <section class="section" style="padding-top: calc(64px + var(--space-2xl));" data-astro-cid-uadgga6g> <div class="container-narrow" data-astro-cid-uadgga6g> <!-- Breadcrumb --> <nav class="breadcrumb" data-astro-cid-uadgga6g> <a href="/docs" data-astro-cid-uadgga6g>Docs</a> <span class="breadcrumb-sep" data-astro-cid-uadgga6g>/</span>
          <span class="breadcrumb-dir" data-astro-cid-uadgga6g>guides</span><span class="breadcrumb-sep" data-astro-cid-uadgga6g>/</span>
          <span class="breadcrumb-dir" data-astro-cid-uadgga6g>operations</span> <span class="breadcrumb-sep" data-astro-cid-uadgga6g>/</span> <span class="breadcrumb-current" data-astro-cid-uadgga6g>nat traversal pilot test</span> </nav> <!-- Source link --> <div class="doc-meta" data-astro-cid-uadgga6g> <a href="https://github.com/InterCooperative-Network/icn/blob/main/guides/operations/nat-traversal-pilot-test.md" target="_blank" class="source-link" data-astro-cid-uadgga6g>
View source on GitHub →
</a> </div> <!-- Rendered markdown --> <article class="prose" data-astro-cid-uadgga6g><h1>NAT Traversal Pilot Test Guide</h1>
<p>Manual testing guide for the C3 NAT Traversal feature.</p>
<h2>5-Minute Smoke Test</h2>
<p>Start a node and verify the full stack in two commands:</p>
<pre><code class="language-bash">cd icn
cargo build --release -p icnd -p icnctl

export ICND=./target/release/icnd
export ICNCTL=./target/release/icnctl
export BASE=/tmp/icn-pilot-test

mkdir -p $BASE/node-a
ICN_KEYSTORE_PASSPHRASE=test $ICND --init --data-dir $BASE/node-a
sed -i &#39;s/min_trust_threshold = 0.1/min_trust_threshold = 0.0/&#39; $BASE/node-a/config.toml

ICN_KEYSTORE_PASSPHRASE=test $ICND --config $BASE/node-a/config.toml &amp;
sleep 5

ICN_KEYSTORE_PASSPHRASE=test $ICNCTL --data-dir $BASE/node-a -e 127.0.0.1:5601 network status
ICN_KEYSTORE_PASSPHRASE=test $ICNCTL --data-dir $BASE/node-a -e 127.0.0.1:5601 ledger head
</code></pre>
<p><strong>Expected output:</strong></p>
<pre><code>Network Actor Status:
  Running:               true
  Listening on:      127.0.0.1:5601
  NAT Traversal:
    Public endpoint:  &lt;your-public-IP&gt;:&lt;port&gt;
    TURN relay:       none
    Active relays:    0
    Last traversal:   Unknown
</code></pre>
<pre><code>Ledger is empty
</code></pre>
<p>If both commands succeed, the following are all functioning:</p>
<ul>
<li>STUN public endpoint discovery</li>
<li>NAT classification and candidate derivation</li>
<li>Authenticated CLI-to-RPC path</li>
<li>Keystore unlock via <code>ICN_KEYSTORE_PASSPHRASE</code></li>
<li>Gossip topic initialization (<code>network:candidates</code>)</li>
<li>Clean null-result handling for empty ledger state</li>
</ul>
<h2>Prerequisites</h2>
<ul>
<li>ICN repo on <code>main</code> (commit <code>861dec3c</code> or later)</li>
<li>Rust toolchain (stable)</li>
<li>Two terminals (or <code>tmux</code>/<code>screen</code>) for two-node testing</li>
<li>Internet access (for STUN servers)</li>
</ul>
<h2>Full Two-Node Test</h2>
<h3>1. Build</h3>
<pre><code class="language-bash">cd icn
cargo build --release -p icnd -p icnctl
</code></pre>
<h3>2. Initialize Two Nodes</h3>
<pre><code class="language-bash">export ICND=./target/release/icnd
export ICNCTL=./target/release/icnctl
export BASE=/tmp/icn-pilot-test

mkdir -p $BASE/node-a $BASE/node-b

ICN_KEYSTORE_PASSPHRASE=test $ICND --init --data-dir $BASE/node-a
ICN_KEYSTORE_PASSPHRASE=test $ICND --init --data-dir $BASE/node-b
</code></pre>
<p>Record the DIDs printed during init — you&#39;ll need them for peer connectivity.</p>
<h3>3. Configure Non-Conflicting Ports</h3>
<p>Both nodes default to the same ports. Edit Node B&#39;s config:</p>
<table>
<thead>
<tr>
<th>Setting</th>
<th>Node A (default)</th>
<th>Node B (change to)</th>
</tr>
</thead>
<tbody><tr>
<td><code>[network] listen_addr</code></td>
<td><code>0.0.0.0:9000</code></td>
<td><code>0.0.0.0:9001</code></td>
</tr>
<tr>
<td><code>[network] rpc_port</code></td>
<td><code>5601</code></td>
<td><code>5602</code></td>
</tr>
<tr>
<td><code>[observability] metrics_port</code></td>
<td><code>9100</code></td>
<td><code>9101</code></td>
</tr>
<tr>
<td><code>[observability] health_port</code></td>
<td><code>8080</code></td>
<td><code>8081</code></td>
</tr>
<tr>
<td><code>[gateway] bind_addr</code></td>
<td><code>0.0.0.0:8000</code></td>
<td><code>0.0.0.0:8001</code></td>
</tr>
</tbody></table>
<p>On <strong>both</strong> nodes, set <code>min_trust_threshold = 0.0</code> so fresh nodes (with no mutual trust) can connect:</p>
<pre><code class="language-toml">[network]
min_trust_threshold = 0.0
</code></pre>
<h3>4. Start Both Nodes</h3>
<p><strong>Terminal 1 (Node A):</strong></p>
<pre><code class="language-bash">ICN_KEYSTORE_PASSPHRASE=test $ICND --config $BASE/node-a/config.toml
</code></pre>
<p><strong>Terminal 2 (Node B):</strong></p>
<pre><code class="language-bash">ICN_KEYSTORE_PASSPHRASE=test $ICND --config $BASE/node-b/config.toml
</code></pre>
<p>The gateway starts automatically (enabled by default in the generated config).</p>
<h3>5. Verify Both Nodes</h3>
<p><strong>Primary check — <code>network status</code>:</strong></p>
<pre><code class="language-bash"># Node A
ICN_KEYSTORE_PASSPHRASE=test $ICNCTL --data-dir $BASE/node-a -e 127.0.0.1:5601 network status

# Node B
ICN_KEYSTORE_PASSPHRASE=test $ICNCTL --data-dir $BASE/node-b -e 127.0.0.1:5602 network status
</code></pre>
<p>Both should show:</p>
<ul>
<li><code>Running: true</code></li>
<li>A STUN-derived public endpoint (e.g. <code>173.x.x.x:port</code>)</li>
<li>NAT traversal section with relay status and traversal mode</li>
</ul>
<p><strong>Gateway health:</strong></p>
<pre><code class="language-bash">curl -s http://127.0.0.1:8000/v1/health
# {&quot;status&quot;:&quot;ok&quot;,&quot;version&quot;:&quot;0.1.0&quot;}

curl -s http://127.0.0.1:8001/v1/health
# {&quot;status&quot;:&quot;ok&quot;,&quot;version&quot;:&quot;0.1.0&quot;}
</code></pre>
<p><strong>Ledger (confirms RPC null-result handling):</strong></p>
<pre><code class="language-bash">ICN_KEYSTORE_PASSPHRASE=test $ICNCTL --data-dir $BASE/node-a -e 127.0.0.1:5601 ledger head
# Ledger is empty
</code></pre>
<h3>6. NAT Traversal Config</h3>
<p>The generated config includes a <code>[network.nat_dial]</code> section:</p>
<pre><code class="language-toml">[network.nat_dial]
parallel_dial = true              # Try direct + relay simultaneously
local_dial_timeout_ms = 2000      # LAN direct dial timeout
public_dial_timeout_ms = 10000    # Public direct dial timeout
relay_dial_timeout_ms = 30000     # TURN relay dial timeout
candidate_announce_interval_secs = 150  # How often to re-announce
</code></pre>
<h3>Optional: TURN relay testing</h3>
<p>To test relay fallback, add TURN server config:</p>
<pre><code class="language-toml">[network]
turn_server = &quot;turn.example.com:3478&quot;
turn_username = &quot;user&quot;
turn_password = &quot;pass&quot;
</code></pre>
<p>Without a TURN server, relay paths won&#39;t activate. The transport layer will use direct connections only. The relay path is covered by the <code>relay_fallback</code> integration test.</p>
<h3>7. Cleanup</h3>
<pre><code class="language-bash"># Stop both nodes (Ctrl+C in each terminal)
rm -rf /tmp/icn-pilot-test
</code></pre>
<h2>Advanced Diagnostics</h2>
<p>Use these steps only if <code>network status</code> shows unexpected values.</p>
<h3>STUN discovery (log inspection)</h3>
<p>Look for this line in daemon output:</p>
<pre><code>INFO icn_net::session: Discovered public endpoint: &lt;IP&gt;:&lt;PORT&gt; (local: 0.0.0.0:9000)
</code></pre>
<h3>NAT candidate announcement (log inspection)</h3>
<pre><code>INFO icn_core::supervisor::init_bootstrap: Connection candidate: local=0.0.0.0:9000, public=Some(&lt;IP&gt;:&lt;PORT&gt;), relay=None
</code></pre>
<h3>Prometheus metrics</h3>
<pre><code class="language-bash">curl -s http://127.0.0.1:9100/metrics | grep -E &quot;stun|nat_|relay&quot;
</code></pre>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Meaning</th>
</tr>
</thead>
<tbody><tr>
<td><code>icn_stun_discovery_total{result=&quot;success&quot;}</code></td>
<td>STUN binding succeeded</td>
</tr>
<tr>
<td><code>icn_nat_dial_attempts_total{type=&quot;candidate_change&quot;}</code></td>
<td>NAT dial triggered</td>
</tr>
<tr>
<td><code>icn_nat_relay_active</code></td>
<td>Active TURN relay sessions (0 without TURN)</td>
</tr>
</tbody></table>
<h3>Peer connectivity</h3>
<p>Two nodes on the same machine discover each other via mDNS but may not auto-establish QUIC sessions. To force a connection, add the other node as a bootstrap peer:</p>
<pre><code class="language-toml">[network]
bootstrap_peers = [&quot;127.0.0.1:9001&quot;]  # In node-a&#39;s config, point to node-b
</code></pre>
<h2>What This Pilot Proves</h2>
<ul>
<li>Full STUN public endpoint discovery</li>
<li>NAT classification and address derivation</li>
<li>Connection candidate gossip initialization</li>
<li>Authenticated CLI-to-RPC path (unified passphrase handling)</li>
<li>Clean empty-state responses (ledger, network)</li>
<li>Configurable dial timeouts and parallel dial strategy</li>
<li>TURN relay fallback (with integration test; requires real TURN server for live test)</li>
</ul>
</article> <!-- Footer nav --> <div class="doc-footer" data-astro-cid-uadgga6g> <a href="/docs" class="btn btn-ghost" data-astro-cid-uadgga6g>← Back to Docs</a> </div> </div> </section>  </main> <!-- Footer --> <footer class="footer"> <div class="container"> <div class="footer-inner"> <div class="footer-brand"> <a href="/" class="nav-logo"> <svg class="nav-logo-svg" width="28" height="28" viewBox="0 0 128 128" fill="none"> <rect width="128" height="128" rx="28" fill="url(#ft-bg)"></rect> <line x1="64" y1="30" x2="34" y2="82" stroke="url(#ft-teal)" stroke-width="4" stroke-linecap="round" opacity="0.6"></line> <line x1="64" y1="30" x2="94" y2="82" stroke="url(#ft-teal)" stroke-width="4" stroke-linecap="round" opacity="0.6"></line> <line x1="34" y1="82" x2="94" y2="82" stroke="url(#ft-teal)" stroke-width="4" stroke-linecap="round" opacity="0.6"></line> <circle cx="64" cy="30" r="11" fill="url(#ft-teal)"></circle> <circle cx="34" cy="82" r="11" fill="url(#ft-teal)"></circle> <circle cx="94" cy="82" r="11" fill="url(#ft-teal)"></circle> <circle cx="64" cy="64" r="4" fill="url(#ft-teal)" opacity="0.8"></circle> <defs> <linearGradient id="ft-bg" x1="0" y1="0" x2="1" y2="1"><stop stop-color="#0f2027"></stop><stop offset="1" stop-color="#0a1628"></stop></linearGradient> <linearGradient id="ft-teal" x1="0" y1="0" x2="1" y2="1"><stop stop-color="#2dd4bf"></stop><stop offset="1" stop-color="#38bdf8"></stop></linearGradient> </defs> </svg> <span>InterCooperative Network</span> </a> <p>A substrate daemon for the cooperative internet. Infrastructure for cooperatives, communities, and federations.</p> </div> <div class="footer-col"> <h4>Project</h4> <ul> <li><a href="/about">About</a></li> <li><a href="/docs">Documentation</a></li> <li><a href="/architecture">Architecture</a></li> <li><a href="/roadmap">Roadmap</a></li> </ul> </div> <div class="footer-col"> <h4>Resources</h4> <ul> <li><a href="/docs/GETTING_STARTED">Getting Started</a></li> <li><a href="/docs/glossary">Glossary</a></li> <li><a href="/docs/CONTRIBUTING">Contributing</a></li> <li><a href="https://github.com/InterCooperative-Network/icn/discussions" target="_blank">Discussions</a></li> </ul> </div> <div class="footer-col"> <h4>Community</h4> <ul> <li><a href="https://github.com/InterCooperative-Network/icn" target="_blank">GitHub</a></li> <li><a href="https://github.com/InterCooperative-Network/icn/issues" target="_blank">Issues</a></li> <li><a href="/community">Community</a></li> </ul> </div> </div> <div class="footer-bottom"> <span>AGPL-3.0 License · InterCooperative Network</span> <span>Built with cooperation, not extraction</span> </div> </div> </footer> <script>
    // Mobile nav toggle
    document.getElementById('nav-toggle')?.addEventListener('click', () => {
      document.getElementById('nav-links')?.classList.toggle('open');
    });

    // Scroll-reveal animations
    const revealObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('revealed');
          revealObserver.unobserve(entry.target);
        }
      });
    }, { threshold: 0.1, rootMargin: '0px 0px -40px 0px' });

    document.querySelectorAll('.card, .section-header, .arch-box, .stage-item, .docs-section-card, .primitive').forEach(el => {
      el.classList.add('reveal');
      revealObserver.observe(el);
    });
  </script> </body> </html> 